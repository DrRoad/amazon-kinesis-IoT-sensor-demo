<!DOCTYPE html>
<html>
<head>
			<meta charset="utf-8">

			<title>AWS IoT Sensor Demo Producer</title>

            <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.5.min.js" type="text/javascript"></script>	

			<script src="fulltilt.min.js" type="text/javascript"></script>

			<style>
			* {
				font-family: Arial, Helvetica, sans-serif;
			}

			.dataGroup {
				border: 1px dashed #000;
				padding: 10px;
				margin: 20px;
				-webkit-perspective: 300; perspective: 300;
			}
			
		    .logo {
		      width:200px;
		      margin-left: auto;
		      margin-right: auto;
		      display: block;
		      padding: 15px;
		    }
    

			table {
				margin-bottom: 20px;
			}

			tr {
				padding: 5px;
			}

			th, td {
				text-align: left;
				padding: 8px;
			}

			table tbody th {
				width: 300px;
				background-color: #EEE;
			}

			table tbody td {
				width: 100px;
				background-color: lightyellow;
			}
			</style>
</head>

<script>

function printDataValue(input) {
	if( input === undefined )
		return "undefined";
	if( input === null )
		return "null";
	if( input === true )
		return "true";
	if( input === false )
		return "false";
	if( Object.prototype.toString.call(input) === "[object Number]" )
		return Math.round((input + 0.00001) * 100) / 100; // return to 2 decimal places

	return (input + ""); // force stringify
}


// Google Analytics
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
 ga('create', 'UA-60769441-1', 'auto');
 ga('send', 'pageview');
 
 
 
// function to collect data and send it to Kinesis
function init() {
	
    // get AWS credentials from Cognito in eu-west-1
	AWS.config.region = 'eu-west-1'; 
	AWS.config.credentials = new AWS.CognitoIdentityCredentials(
		{ AccountId: '454979696062', IdentityPoolId: 'eu-west-1:e727b637-5679-4e38-adaa-3b2c646cbde6:',
		RoleArn: 'arn:aws:iam::454979696062:role/Cognito_IoTSensorDemoUnauth_DefaultRole' });
	AWS.config.credentials.get(function() { 
		console.log("updated aws config with web identity federation:\n", AWS.config.credentials);
		AWS.config.identityId = AWS.config.credentials.identityId; 
		console.log("identityId:", AWS.config.identityId); 
	});

    // region switch to connect with correct Kinesis
    //AWS.config.region = 'us-west-2';
    AWS.config.region = 'eu-west-1';
	var kinesis = new AWS.Kinesis();
	//console.log(kinesis)
    var sregion = document.getElementById("sregion");
    sregion.textContent = printDataValue(AWS.config.region);
	
    // empty object for records
	var records=[];
	
	// object for cognito ID
	var cognitoId = document.getElementById("cognitoId");
	
	// object for device type	
	var device = document.getElementById("device");
	device.textContent = printDataValue(navigator.platform);
	
	// object for moving HTML 5 logo
	var logo = document.getElementById("imgLogo");

	// objects for Device Orientation
	var screenAlpha = document.getElementById("screenAlpha");
	var screenBeta = document.getElementById("screenBeta");
	var screenGamma = document.getElementById("screenGamma");

	// Start FULLTILT DeviceOrientation listeners and register our callback
	var deviceOrientation = FULLTILT.getDeviceOrientation({'type': 'world'});
	deviceOrientation.then(function(orientationData) {	

		orientationData.listen(function() {
			
			cognitoId.textContent = printDataValue(AWS.config.credentials.identityId);

			// Display calculated screen-adjusted deviceorientation
			var screenAdjustedEvent = orientationData.getFixedFrameEuler();

			screenAlpha.textContent = printDataValue(screenAdjustedEvent.alpha);
			screenBeta.textContent = printDataValue(screenAdjustedEvent.beta);
			screenGamma.textContent = printDataValue(screenAdjustedEvent.gamma);
			
			screenAlpha.KinesisContent = screenAdjustedEvent.alpha;
			screenBeta.KinesisContent = screenAdjustedEvent.beta;
			screenGamma.KinesisContent = screenAdjustedEvent.gamma;
			
			// transform HTML 5 object
			logo.style.webkitTransform = "rotate("+ screenAdjustedEvent.gamma +"deg) rotate3d(1,0,0, "+ (screenAdjustedEvent.beta*-1)+"deg)";
			logo.style.MozTransform = "rotate("+ screenAdjustedEvent.gamma +"deg)";
			logo.style.transform = "rotate("+ screenAdjustedEvent.gamma +"deg) rotate3d(1,0,0, "+ (screenAdjustedEvent.beta*-1)+"deg)";
			
		});

	});

	var screenAccGX = document.getElementById("screenAccGX");
	var screenAccGY = document.getElementById("screenAccGY");
	var screenAccGZ = document.getElementById("screenAccGZ");

	// Start FULLTILT DeviceMotion listeners and register our callback
	var deviceMotion = FULLTILT.getDeviceMotion();
	deviceMotion.then(function(motionData) {

		motionData.listen(function() {

			// Display calculated screen-adjusted devicemotion
			var screenAccG = motionData.getScreenAdjustedAccelerationIncludingGravity() || {};

			screenAccGX.textContent = printDataValue(screenAccG.x);
			screenAccGY.textContent = printDataValue(screenAccG.y);
			screenAccGZ.textContent = printDataValue(screenAccG.z);
			
			screenAccGX.KinesisContent = screenAccG.x;
			screenAccGY.KinesisContent = screenAccG.y;
			screenAccGZ.KinesisContent = screenAccG.z;

		});
		
	});
	
	
    // create JSON objec to put into kinesis
	function CreateKinesisInput() {
		
		var cT = new Date().getTime()/1000;
		
		if(AWS.config.credentials.identityId != null)
		{
			var jsonstrOrientation ='{"recordTime":'+cT+',"cognitoId":"'+AWS.config.credentials.identityId+'","device":"'+navigator.platform+'","sensorname":"screenAdjustedEvent","alpha":'+screenAlpha.KinesisContent+', "beta":'+screenBeta.KinesisContent+', "gamma":'+screenGamma.KinesisContent+'}';
			records.push({
		  	  Data: jsonstrOrientation,
				PartitionKey: "screenAdjustedEvent"
			})

			var jsonstrMotion = '{"recordTime":'+cT+',"cognitoId":"'+AWS.config.credentials.identityId+'","device":"'+navigator.platform+'","sensorname":"screenAccG","x":'+screenAccGX.KinesisContent +', "y":'+screenAccGY.KinesisContent +', "z":'+screenAccGZ.KinesisContent +'}';
			records.push({
		  	  Data: jsonstrMotion,
				PartitionKey: "screenAccG"
			})
	
		}

        // set timeout to collect data every dt-time
	    setTimeout(function(){CreateKinesisInput()}, 1000/3);
		

	}
	CreateKinesisInput();	
	
    // send records object to kinesis
	function SendKinesis() {

		if(records.length > 0) {
			var params = {
 				Records: records,
 	 	    	StreamName: 'IoTSensorDemo'
			};
			kinesis.putRecords(params, function(err, data) {
 				if (err) console.log(err, err.stack); // an error occurred
 				 //else     console.log(data);           // successful response
			});
			records=[];
		}

   	 	setTimeout(function(){SendKinesis()}, document.getElementById("update").value*1000);

	}
	SendKinesis();
	


}

window.onload = init;

</script>




<body>
    
    <img align="right" alt="" src="aws_proserve_logo.png" width="300" />
    <div>
        <h1>AWS IoT Sensor Demo Producer</h1>
        <p>Screen-Adjusted DeviceOrientation, Screen-Adjusted DeviceMotion, device type and Cognito Id will be send every <select name="update" id="update">
            <option value=1>1</option>
            <option value=2>2</option>
            <option value=3 selected>3</option>
            <option value=4>4</option>
            <option value=5>5</option>
        </select> seconds via https to the AWS Cloud <b id="sregion">-</b> region and stored for data anlyses. Have fun getting part of a Internet of Things Sensor Demo.</p>
    </div>
    
    


<h3>Device Data</h3>
<div class="dataGroup">

	<table>
		<thead>
			<tr>
				<th>Cognito Id</th>
				<th>Device</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td id="cognitoId">-</td>
				<td id="device">-</td>
			</tr>
		</tbody>
	</table>

</div>

<h3>Screen-Adjusted DeviceOrientation</h3>
<div class="dataGroup">

	<table>
		<thead>
			<tr>
				<th>.alpha</th>
				<th>.beta</th>
				<th>.gamma</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td id="screenAlpha">-</td>
				<td id="screenBeta">-</td>
				<td id="screenGamma">-</td>
			</tr>
		</tbody>
	</table>

</div>
<div class="dataGroup" style="perspective: 200;">
  <img src="aws_logo.jpg" id="imgLogo" class="logo">
</div>


<h3>Screen-Adjusted DeviceMotion including Gravity</h3>
<div class="dataGroup">

	<table>
		<thead>
			<tr>
				<th>.x</th>
				<th>.y</th>
				<th>.z</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td id="screenAccGX">-</td>
				<td id="screenAccGY">-</td>
				<td id="screenAccGZ">-</td>
			</tr>
		</tbody>
	</table>


</div>


<p><em>Data values, where provided, are rounded to two decimal places for readability.</em></p>

<p><em>Thanks to Rich Tibbett and Pete LePage for providing this demo code at <a href="https://richtr.github.io/Full-Tilt/examples/data_display.html" target="_blank">github.io</a> and <a href="http://www.html5rocks.com/en/tutorials/device/orientation/" target="_blank">www.html5rocks.com</a></em>.</p>

<p><em>JavaScript DeviceOrientation Event Specification can be found at <a href="http://w3c.github.io/deviceorientation/spec-source-orientation.html" target="_blank">w3c.github.io</em>.</a>
</p>

</body>
</html>